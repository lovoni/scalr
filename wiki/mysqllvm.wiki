#summary Introduction to mysqllvm role
#labels mysql,mysqllvm

* This is a draft

= Introduction =

LVM-enabled mysql role differs by LVM_ENABLED=1 key value in `/etc/scalr_lvm.conf`


= Initialization of LVM-enabled instance =

  # Creates physical volumes on all available disks.
  # Assigns them into a single volume group.
  # Based on config in /etc/scalr_lvm.conf creates three logical volumes: 

On the small instance config looks like:

{{{
# Logical Volume for MySQL data
LV_DATA_NAME="lvol0"
LV_DATA_SIZE="65G"
LV_DATA_MPT="/mnt/mysql-data"

# Logical Volume for MySQL logs and data snapshot
LV_MISC_NAME="lvol1"
LV_MISC_SIZE="75G"
LV_MISC_MPT="/mnt/mysql-misc"

# Logical Volume to snapshot MySQL data
LV_SNAP_NAME="snap"
LV_SNAP_SIZE="9G"
LV_SNAP_MPT="/mnt/mysql-snap"
}}}

4. Deploys directory skeleton from /usr/local/aws/skel


=  Backup snapshot creation =

Unlike the regular bundle, it takes only few seconds to create a snapshot and release table locks.

Snapshots are split into 150MB before upload to S3.

= Volume sizes and initialization times =

On big instance types LVM uses all available attached devices to create a volume group by default.
Thus instance initialization is time-consuming on mysqllvm64 role.

=== m1.large===
Total space available for data storage: ~350GB

Average init time: 10 minutes

=== m1.xlarge===
Total space available for data storage: ~750GB

Average init time: 20 minutes

= Migrating  from non-lvm mysql role =
Go to Farms -> View all, locate your farm in the list and Open Options->  Backup/Bundle MySQL data
  #   Locate your MySQL master instance on the farm map. 
  #   Click on options and then "Backup/bundle MySQL data". Then click "Bundle MySQL data now" button.
This will save the latest data snaphot on S3. Wait until this operation will complete.
  # Disable old mysql role (untick in Farm Builder)
  # Enable the new mysqllvm role. (tick in Farm Builder).

Be warned that mysql is unavailable in the timespan  between #3 and #4 above.
You may also want to restart a farm after all.